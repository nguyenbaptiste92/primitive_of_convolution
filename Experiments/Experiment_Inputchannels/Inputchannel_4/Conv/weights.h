#include "nnom.h"

#define CONV2D_KERNEL_0 {-56, 20, -59, 67, 21, 62, 70, 76, 75, 15, -89, 50, 51, -59, -5, 1, -50, 66, 49, 65, 11, -10, -25, -16, 20, -88, 69, 22, 75, -14, 0, -89, -34, -64, 33, -91, -14, 18, -72, -4, 36, 45, 80, -78, -62, -80, 41, -7, -10, 27, -66, -31, -59, 50, 30, -7, 67, -13, 75, -23, -53, -1, -83, -84, 71, 61, -93, 4, 74, 64, 14, 57, 20, -61, 93, -32, -51, 69, 48, -32, 19, 4, -80, 80, -38, 33, 62, -70, 12, -62, 47, 57, 51, 78, -52, -82, 33, 41, 0, 46, 68, 58, -66, 31, 17, -92, -74, 23, 31, 12, -71, -82, 65, -26, 29, 89, -9, -4, -89, 37, 18, -74, 82, -9, -37, -57, 49, 77, 51, -90, 61, 44, -90, 7, 31, -70, -12, 89, 88, 26, -17, -85, 18, 27, 44, 17, 81, 17, -28, -83, 14, 87, 83, -25, 0, 5, -4, 70, -11, -54, 11, 81, 50, -89, -20, 60, -73, -14, -9, -77, -77, -19, -13, -33, 45, 90, 56, -86, 77, -71, -47, -11, -58, 60, 35, 82, -79, 87, -44, 23, 74, -57, 89, -38, 69, -27, -5, -69, 40, -55, 69, 85, 80, -22, -26, 31, 26, 5, -56, 84, -81, 20, -25, -54, -64, 86, 52, -11, 17, -8, -87, 22, 17, 83, -15, 53, -18, 53, 69, 17, 6, 29, 32, -13, -63, 22, -88, 85, -79, -58, -53, 16, 16, 70, 62, -3, 79, 65, 57, 51, 39, -70, 29, -54, 71, 82, 31, -24, -19, 93, 84, 31, 26, -2, -25, -52, -41, 25, -42, -16, 93, 21, -13, 3, 60, -69, 71, 79, 49, -32, -76, -6, 22, 56, 57, -27, -6, -56, -85, -45, 53, 63, -59, 31, 48, 81, 25, 51, 28, -87, -36, 56, -91, -46, -91, -53, 18, -71, 68, -11, 17, 77, 46, -88, -7, 2, -8, 0, 80, 62, -19, -84, 65, -39, -19, -48, 7, -23, -25, -29, 6, -9, -42, 67, 53, 41, 78, -53, 52, -44, -88, 49, -93, -14, 42, 33, 9, -14, 11, -28, -7, 90, -90, 76, 62, -16, 20, -79, 42, -1, -84, 58, -38, 67, 74, 90, -58, -45, -71, -3, -63, -84, 21, 37, -36, -22, 73, -51, -46, 51, 37, -17, -35, 1, -89, -29, -91, -26, -47, -73, 25, 64, -78, -89, -34, -17, -29, 60, 85, -90, -67, 71, 19, 71, 65, 29, -4, 32, -36, 67, 8, -18, 48, 89, 28, 68, 69, 17, 54, -65, 52, 25, -51, -79, -23, 92, 16, -4, 89, -4, 60, -86, 73, -64, 0, -20, 8, 59, 9, 87, 8, -15, 48, 89, 42, 2, -87, -1, -24, -31, -92, 53, 12, 88, -53, -22, 57, 51, -92, 16, 85, -77, 43, -84, 81, -66, -5, -48, -53, -21, -45, 48, 33, 45, -2, 62, -29, -6, 22, -93, 12, -45, -65, 93, 25, 49, 33, 82, -63, -72, 9, -70, 42, 8, -22, 68, -41, -32, -48, 62, -63, 24, -67, -15, 58, 20, -16, 90, 93, 47, -44, 82, -38, -76, -22, 8, 79, 86, 17, -64, -22, -84, 35, -43, -85, -77, -41, 67, 69, -41, 51, -39, 11, 35, 72, -84, 79, 18, -87, 7, -57, 46, -12, 86, -67, 33, 23, 43, 93, 30, 0, -42, -83, 12, 21, -31, -1, 87, -91, 26, -73, 11, 15, 60, 31, 44, -25, -10, -69, -26, -81, 3, -17, -28, -86, -50}

#define CONV2D_KERNEL_0_SHIFT (9)

#define CONV2D_BIAS_0 {-30, 93, -97, -103, 59, -87, -102, -94, -19, 100, 8, -30, -43, 87, 31, -20}

#define CONV2D_BIAS_0_SHIFT (8)


/* output enconding for each layer */
#define INPUT_1_OUTPUT_SHIFT 7
#define CONV2D_OUTPUT_SHIFT 6

/* bias shift and output shift for each layer */
#define CONV2D_OUTPUT_RSHIFT (INPUT_1_OUTPUT_SHIFT+CONV2D_KERNEL_0_SHIFT-CONV2D_OUTPUT_SHIFT)
#define CONV2D_BIAS_LSHIFT   (INPUT_1_OUTPUT_SHIFT+CONV2D_KERNEL_0_SHIFT-CONV2D_BIAS_0_SHIFT)
#if CONV2D_OUTPUT_RSHIFT < 0
#error CONV2D_OUTPUT_RSHIFT must be bigger than 0
#endif
#if CONV2D_BIAS_LSHIFT < 0
#error CONV2D_BIAS_LSHIFT must be bigger than 0
#endif

/* weights for each layer */
static const int8_t conv2d_weights[] = CONV2D_KERNEL_0;
static const nnom_weight_t conv2d_w = { (const void*)conv2d_weights, CONV2D_OUTPUT_RSHIFT};
static const int8_t conv2d_bias[] = CONV2D_BIAS_0;
static const nnom_bias_t conv2d_b = { (const void*)conv2d_bias, CONV2D_BIAS_LSHIFT};

/* nnom model */
static int8_t nnom_input_data[4096];
static int8_t nnom_output_data[16384];
static nnom_model_t* nnom_model_create(void)
{
	static nnom_model_t model;
	nnom_layer_t* layer[3];

	new_model(&model);

	layer[0] = Input(shape(32, 32, 4), nnom_input_data);
	layer[1] = model.hook(Conv2D(16, kernel(3, 3), stride(1, 1), dilation(1, 1), PADDING_SAME, &conv2d_w, &conv2d_b), layer[0]);
	layer[2] = model.hook(Output(shape(32, 32, 16), nnom_output_data), layer[1]);
	model_compile(&model, layer[0], layer[2]);
	return &model;
}
